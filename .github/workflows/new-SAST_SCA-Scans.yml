name: DVWA Security Scan

on:
  push:
    branches:
      - main

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # Checkout Code
      # -----------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # -----------------------
      # Set up PHP
      # -----------------------
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      # ----------------------------
      # SAST: SonarCloud Scan
      # -----------------------
      - name: SonarCloud Scan (SAST)
        uses: sonarsource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=fahathgd-droid_test-app1
            -Dsonar.organization=fahathgd-droid
            -Dsonar.sources=.
            -Dsonar.exclusions=config/**,docs/**,tests/**,**/*.sql
            -Dsonar.host.url=https://sonarcloud.io

      # -----------------------
      # SCA: OWASP Dependency Check
      # -----------------------
      - name: Run OWASP Dependency Check (SCA)
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'DVWA-App'
          path: '.'
          format: 'ALL'
          out: 'reports'
          args: >
            --exclude **/passwordProtected.zip
            --exclude **/arbitraryFileWrite.zip
            --exclude **/videoExploit.zip

      # -----------------------
      # DAST: OWASP ZAP Baseline Scan
      # -----------------------
  #    - name: Run OWASP ZAP Baseline Scan (DAST)
  #      uses: zaproxy/action-baseline@v0.10.0
  #      with:
  #        target: "http://testphp.vulnweb.com/"  # or "http://zero.webappsecurity.com/"
  #        cmd_options: >
  #          -a
  #          -r zap-report.html
  #          -m 5  # limit to 5 mins max passive scan to keep run short
  #        fail_action: false
  #        allow_issue_writing: true
  #        artifact_name: zap_scan
  #      env:
  #        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #        WORKSPACE: /tmp  # prevents /zap/wrk permission issues
  #        COMPOSER_PROCESS_TIMEOUT: 0
  #        COMPOSER_NO_INTERACTION: 1
  #        COMPOSER_NO_AUDIT: 1

      # -----------------------
      # Combine Reports (Fixed Permissions)
      # --------------------------
      - name: Calculate Combined Security Risk
        run: |
            echo "Checking JQ Installation"
            jq --version
            echo "üîé Calculating Security Risk..."

            # ----------------------------
            # 1Ô∏è‚É£ Dependency Check Counts
            # ----------------------------
            DC_CRITICAL=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="CRITICAL")] | length' reports/dependency-check-report.json)
            DC_HIGH=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="HIGH")] | length' reports/dependency-check-report.json)
            DC_MEDIUM=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="MEDIUM")] | length' reports/dependency-check-report.json)
            DC_LOW=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="LOW")] | length' reports/dependency-check-report.json)

            # ----------------------------
            # 2Ô∏è‚É£ SonarCloud Counts
            # ----------------------------
            curl -s -u ${{ secrets.SONAR_TOKEN }}: \
              "https://sonarcloud.io/api/issues/search?componentKeys=fahathgd-droid_test-app1&types=VULNERABILITY&ps=100" \
              -o sonar.json

            SONAR_CRITICAL=$(jq '[.issues[] | select(.severity=="BLOCKER" or .severity=="CRITICAL")] | length' sonar.json)
            SONAR_HIGH=$(jq '[.issues[] | select(.severity=="MAJOR")] | length' sonar.json)
            SONAR_MEDIUM=$(jq '[.issues[] | select(.severity=="MINOR")] | length' sonar.json)
            SONAR_LOW=$(jq '[.issues[] | select(.severity=="INFO")] | length' sonar.json)

            echo "added--------Seperate counts"
            # 3Ô∏è‚É£ Print Individual Results
            # ----------------------------
            echo "--------------------------------------"
            echo "üõ°Ô∏è SCA (Dependency Check) Counts"
            echo "Critical : $DC_CRITICAL"
            echo "High     : $DC_HIGH"
            echo "Medium   : $DC_MEDIUM"
            echo "Low      : $DC_LOW"
            echo "--------------------------------------"

            echo "üîç SAST (SonarCloud) Counts"
            echo "Critical : $SONAR_CRITICAL"
            echo "High     : $SONAR_HIGH"
            echo "Medium   : $SONAR_MEDIUM"
            echo "Low      : $SONAR_LOW"
            echo "--------------------------------------"

            # ----------------------------
            # 4Ô∏è‚É£ Combined Totals
            # ----------------------------
            TOTAL_CRITICAL=$((DC_CRITICAL + SONAR_CRITICAL))
            TOTAL_HIGH=$((DC_HIGH + SONAR_HIGH))
            TOTAL_MEDIUM=$((DC_MEDIUM + SONAR_MEDIUM))
            TOTAL_LOW=$((DC_LOW + SONAR_LOW))

            echo "üìä Combined Totals"
            echo "Critical : $TOTAL_CRITICAL"
            echo "High     : $TOTAL_HIGH"
            echo "Medium   : $TOTAL_MEDIUM"
            echo "Low      : $TOTAL_LOW"
            echo "--------------------------------------"
            # ----------------------------
            # 3Ô∏è‚É£ Combine Counts
            # ----------------------------
            TOTAL_CRITICAL=$((DC_CRITICAL + SONAR_CRITICAL))
            TOTAL_HIGH=$((DC_HIGH + SONAR_HIGH))
            TOTAL_MEDIUM=$((DC_MEDIUM + SONAR_MEDIUM))
            TOTAL_LOW=$((DC_LOW + SONAR_LOW))

            # ----------------------------
            # 4Ô∏è‚É£ Risk Model
            # ----------------------------
            RISK_SCORE=$((TOTAL_CRITICAL*10 + TOTAL_HIGH*7 + TOTAL_MEDIUM*4 + TOTAL_LOW*1))

            echo "------------------------------------"
            echo "üõ°Ô∏è Combined Security Summary"
            echo "------------------------------------"
            echo "Critical : $TOTAL_CRITICAL"
            echo "High     : $TOTAL_HIGH"
            echo "Medium   : $TOTAL_MEDIUM"
            echo "Low      : $TOTAL_LOW"
            echo "------------------------------------"
            echo "üéØ Final Risk Score : $RISK_SCORE"
            echo "------------------------------------"

      - name: CWE-Based Pure SAST Risk Model
        run: |
          echo "Calculating CWE-Based SAST Risk..."

          # Fetch all SAST issues
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/issues/search?componentKeys=fahathgd-droid_test-app1&types=VULNERABILITY&ps=500" \
            -o sonar.json

          TOTAL_RISK=0

          # Get unique rule keys
          RULES=$(jq -r '.issues[].rule' sonar.json | sort | uniq)

          for RULE in $RULES; do

            # Fetch rule metadata
            curl -s -u ${{ secrets.SONAR_TOKEN }}: \
              "https://sonarcloud.io/api/rules/show?key=$RULE" \
              -o rule.json

            # Extract CWE (first one if multiple)
            CWE=$(jq -r '.rule.cwe[0] // empty' rule.json)

            if [ -z "$CWE" ]; then
              BASE_IMPACT=5.0
            else
              BASE_IMPACT=$(jq -r --arg cwe "$CWE" '.[$cwe] // 5.0' cwe_base_impact.json)
            fi

            # Count how many issues use this rule
            COUNT=$(jq --arg rule "$RULE" '[.issues[] | select(.rule==$rule)] | length' sonar.json)

            RULE_RISK=$(echo "$BASE_IMPACT * $COUNT" | bc -l)

            TOTAL_RISK=$(echo "$TOTAL_RISK + $RULE_RISK" | bc -l)

            echo "Rule: $RULE | CWE: $CWE | Count: $COUNT | BaseImpact: $BASE_IMPACT | PartialRisk: $RULE_RISK"

          done

          echo "----------------------------------------"
          echo "Final SAST Risk Index (CWE-Based): $TOTAL_RISK"
          echo "----------------------------------------"

      # -----------------------
      # Upload Security Reports
      # -----------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            reports
            zap-report.html